# LINUX 2

## Оглавление

1. [Часть 1. Инструмент ipcalc](#Часть1)\
    1.1 [Сети и маски](#Часть1.1)\
    1.2 [localhost](#Часть1.2)\
    1.3 [Диапозоны и сегменты сетей](#Часть1.3)  
2. [Часть 2. Статическая маршрутизация между двумя машинами](#Часть2)\
    2.1 [Добавление статического маршрута вручную](#Часть2.1)\
    2.2 [Добавление статического маршрута с сохранением ](#Часть2.2)
3. [Часть 3. Утилита iperf3](#Часть3)\
    3.1 [Скорость соединения](#Часть3.1)\
    3.2 [Утилита iperf3](#Часть3.2)
4. [Часть 4. Сетевой экран](#Часть4) 
5. [Часть 5. Статическая маршрутизация сети](#Часть5) 
6. [Часть 6. Динамическая настройка IP с помощью DHCP](#Часть6) 
7. [Часть 7. NAT](#Часть7) 
8. [Часть 8. Допополнительно. Знакомство с SSH Tunnels](#Часть8)


## <div id = "Часть1"></div> Часть 1. Инструмент ipcalc

##### 1.1 Сети и маски



Определить и записать в отчет:

- Адрес сети 
    - 192.167.38.54/13
        - 192.160.0.0

- Перевод маски:
    - 255.255.255.0
        - префиксная запись: /24
        - двоичная запись: 11111111.11111111.11111111.00000000
    - /15
        - обычная запись: 255.254.0.0
        - двоичная запись: 11111111.11111111.00000000.00000000
    - 11111111.11111111.11111111.11110000
        - обычная запись: 255.255.255.240
        - префиксная запись: /28

- Минимальный и максимальный хост в сети 12.167.38.4 при масках:
    - /8 : 12.0.0.1 - 12.255.255.254
    - 11111111.11111111.00000000.00000000 : 12.167.0.1 - 12.167.255.254
    - 255.255.254.0 : 12.167.38.1 - 12.167.39.254
    - /4 : 0.0.0.1 - 15.255.255.254

##### 1.2. localhost

Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP:

- 194.34.23.100 - нет
- 127.0.0.2 - да
- 127.1.0.1 - да
- 128.0.0.1 - нет

##### 1.3. Диапазоны и сегменты сетей

Определить и записать в отчёт:

- Какие из перечисленных ip можно использовать в качестве публичных, а какие в качестве частных:
    - 10.0.0.45 - приватный
    - 134.43.0.2 - публичный
    - 192.168.4.2 - приватный
    - 172.20.250.4 - приватный
    - 172.0.2.1 - публичный
    - 192.172.0.1 - публичный
    - 172.68.0.2 - публичный
    - 172.16.255.255 - приватный
    - 10.10.10.10 - приватный
    - 192.169.168.1 - публичный

- Какие из перечисленных IP адресов шлюза возможны у сети 10.10.0.0/18:
    - 10.0.0.1 - нет
    - 10.10.0.2 - да
    - 10.10.10.10 - да
    - 10.10.100.1 - нет
    - 10.10.1.255 - нет

## <div id = "Часть2"></div> Часть 2. Статическая маршрутизация между двумя машинами

С помощью команды ip a посмотреть посмотреть сущшествующие сетевые интерфейсы

![linux_network](report-images/1-1.png)
![linux_network](report-images/1-2.png)

Описать сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задать следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12

![linux_network](report-images/1-3.png)
![linux_network](report-images/1-4.png)

Выполнить команду netplan apply для перезапуска сервиса сети

![linux_network](report-images/1-5.png)
![linux_network](report-images/1-6.png)

##### 2.1. Добавление статического маршрута вручную

Добавить статический маршрут от одной машины до другой и обратно при помощи команды вида ip r add.
Пропинговать соединение между машинами.

![linux_network](report-images/1-7.png)
![linux_network](report-images/1-8.png)

##### 2.2. Добавление статического маршрута с сохранением

Добавить статический маршрут от одной машины до другой с помощью файла etc/netplan/00-installer-config.yaml

![linux_network](report-images/1-9.png)
![linux_network](report-images/1-10.png)

Пропинговать соединение между машинами

![linux_network](report-images/1-11.png)
![linux_network](report-images/1-12.png)

## <div id = "Часть3"></div> Часть 3. Утилита iperf3

##### 3.1. Скорость соединения

Перевести и записать в отчёт:
- 8 Mbps в MB/s : 1 MB/s
- 100 MB/s в Kbps : 819200 Kbps
- 1 Gbps в Mbps : 1024 Mbps

##### 3.2. Утилита iperf3

![linux_network](report-images/1-13.png)
![linux_network](report-images/1-14.png)

## <div id = "Часть4"></div> Часть 4. Сетевой экран

##### 4.1. Утилита iptables 

Создать файл /etc/firewall.sh, имитирующий фаерволл

- на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
- на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
- открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
- запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
- разрешить *echo reply* (машина должна "пинговаться")

![linux_network](report-images/1-15.png)
![linux_network](report-images/1-16.png)

Запустить файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh

![linux_network](report-images/1-17.png)
![linux_network](report-images/1-18.png)

- Разница в том, что если запрещающее правило стоит первым, то следующее разврешающее правило не будет работать

##### 4.2. Утилита nmap

Nmap (“Network Mapper”) это утилита с открытым исходным кодом для исследования сети и
       проверки безопасности. Она была разработана для быстрого сканирования больших сетей, хотя
       прекрасно справляется и с единичными целями. Nmap использует сырые IP пакеты оригинальными
       способами, чтобы определить какие хосты доступны в сети, какие службы (название приложения
       и версию) они предлагают, какие операционные системы (и версии ОС) они используют, какие
       типы пакетных фильтров/брандмауэров используются и еще дюжины других характеристик. В тот
       время как Nmap обычно используется для проверки безопасности, многие сетевые и системные
       администраторы находят ее полезной для обычных задач, таких как контролирование структуры
       сети, управление расписаниями запуска служб и учет времени работы хоста или службы.

![linux_network](report-images/1-19.png)
![linux_network](report-images/1-20.png)

## <div id = "Часть5"></div> Часть 5. Статическая маршрутизация сети

![linux_network](report-images/part5_network.png)

##### 5.1. Настройка адресов машин

- w11
![linux_network](report-images/2-1.png)
- w21
![linux_network](report-images/2-2.png)
- w22
![linux_network](report-images/2-3.png)
- r2
![linux_network](report-images/2-4.png)
- r1
![linux_network](report-images/2-5.png)

Команда netplan apply проверит наш конфиг на наличие ошибок и применит его в случае успеха. Если ошибок нет, то командой `ip -4 a` (IPv4) проверить, что адрес машины задан верно.
![linux_network](report-images/2-6.png)
![linux_network](report-images/2-7.png)
![linux_network](report-images/2-8.png)
![linux_network](report-images/2-9.png)
![linux_network](report-images/2-10.png)

Пропинговать ws22 с ws21 и r1 с ws11.
![linux_network](report-images/2-11.png)
![linux_network](report-images/2-12.png)

##### 5.2. Включение переадресации IP-адресов.

Для включения переадресации IP, выполнить команду на роутерах:
`sysctl -w net.ipv4.ip_forward=1` 
![linux_network](report-images/2-13.png)
![linux_network](report-images/2-14.png)

IP-переадресация включена на постоянной основе.
![linux_network](report-images/2-15.png)
![linux_network](report-images/2-16.png)

##### 5.3. Установка маршрута по-умолчанию

Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить gateway4 \[ip роутера\] в файле конфигураций.

- w11
![linux_network](report-images/2-17.png)
- w21
![linux_network](report-images/2-18.png)
- w22
![linux_network](report-images/2-19.png)

Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации.
![linux_network](report-images/2-20.png)
![linux_network](report-images/2-21.png)
![linux_network](report-images/2-22.png)

Пропинговать с ws11 роутер r2 и показать на r2, что пинг доходит. Для этого использовать команду:
`tcpdump -tn -i eth1`
![linux_network](report-images/3-1.png)
![linux_network](report-images/3-2.png)

##### 5.4. Добавление статических маршрутов

Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций.
![linux_network](report-images/2-25.png)
![linux_network](report-images/2-26.png)

Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.
![linux_network](report-images/2-23.png)
![linux_network](report-images/2-24.png)

Запустить команды на ws11:
`ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0`
![linux_network](report-images/3-3.png)

Маршрут подбирается по таблице марштрутизаторов. Если маршрут выбран успешно то он будет передан. Если не успешно - пакет не будет передан. Если несколько совпадений - то для переадсресации будет выбран маршрут с самой длинной маской.

##### 5.5. Построение списка маршрутизаторов

Запустить на r1 команду дампа:
`tcpdump -tnv -i eth0`
![linux_network](report-images/3-6.png)

При помощи утилиты **traceroute** построить список маршрутизаторов на пути от ws11 до ws21
![linux_network](report-images/3-7.png)
![linux_network](report-images/3-8.png)

Каждый пакет проходит на своем пути определенное количество узлов, пока достигнет своей цели. Причем, каждый пакет имеет свое время жизни. Это количество узлов, которые может пройти пакет перед тем, как он будет уничтожен. Этот параметр записывается в заголовке TTL, каждый маршрутизатор, через который будет проходить пакет уменьшает его на единицу. При TTL=0 пакет уничтожается, а отправителю отсылается сообщение Time Exceeded.

Команда traceroute linux использует UDP пакеты. Она отправляет пакет с TTL=1 и смотрит адрес ответившего узла, дальше TTL=2, TTL=3 и так пока не достигнет цели. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт, который, скорее всего, не занят. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен трассировка считается завершенной.

##### 5.6. Использование протокола ICMP при маршрутизации

Запустить на r1 перехват сетевого трафика, проходящего через eth0 с помощью команды:
`tcpdump -n -i eth0 icmp`
![linux_network](report-images/3-4.png)
Пропинговать с ws11 несуществующий IP с помощью команды `ping`
![linux_network](report-images/3-5.png)

## <div id = "Часть6"></div> Часть 6. Динамическая настройка IP с помощью DHCP

Для r2 настроить в файле */etc/dhcp/dhcpd.conf* конфигурацию службы **DHCP**. Указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.
![linux_network](report-images/3-9.png)
В файле *resolv.conf* прописать `nameserver 8.8.8.8.`
![linux_network](report-images/3-10.png)
Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`.
![linux_network](report-images/3-11.png)
Машину ws21 перезагрузить при помощи `reboot` и через `ip a` показать, что она получила адрес. Также пропинговать ws22 с ws21.
![linux_network](report-images/3-12.png)
![linux_network](report-images/3-13.png)

Указать MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml* надо добавить строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`
![linux_network](report-images/3-20.png)
Для r1 настроить аналогично r2, но сделать выдачу адресов с жесткой привязкой к MAC-адресу (ws11). Провести аналогичные тесты

![linux_network](report-images/3-16.png)
![linux_network](report-images/3-17.png)
![linux_network](report-images/3-18.png)
ip до обновления и после.
![linux_network](report-images/3-14.png)
![linux_network](report-images/3-15.png)

Запросить с ws21 обновление ip адреса
![linux_network](report-images/3-21.png)
Пинг с обновленным ip у машины ws21
![linux_network](report-images/3-19.png)

## <div id = "Часть7"></div> Часть 7.  **NAT**

В файле /etc/apache2/ports.conf на ws22 и r1 изменить строку Listen 80 на Listen 0.0.0.0:80, то есть сделать сервер Apache2 общедоступным.
Запустить веб-сервер Apache командой service apache2 start на ws22 и r1.

![linux_network](report-images/3-22.png)
![linux_network](report-images/3-23.png)

Добавить в фаервол, на r2 следующие правила:
- Удаление правил в таблице filter - iptables -F
- Удаление правил в таблице "NAT" - iptables -F -t nat
- Отбрасывать все маршрутизируемые пакеты - iptables --policy FORWARD DROP

![linux_network](report-images/4-4.png)
![linux_network](report-images/4-3.png)

Проверить соединение между ws22 и r1 командой `ping`

![linux_network](report-images/4-5.png)

Добавить в файл ещё одно правило:
- Разрешить маршрутизацию всех пакетов протокола **ICMP**
![linux_network](report-images/4-6.png)

Проверить соединение между ws22 и r1 командой `ping`
![linux_network](report-images/4-7.png)

Добавить в файл ещё два правила:
- Включить **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0)
- Включить **DNAT** на 8080 порт машины r2 и добавить к веб-серверу Apache, запущенному на ws22, доступ извне сети
![linux_network](report-images/4-8.png)

Проверить соединение по TCP для **SNAT**, для этого с ws22 подключиться к серверу Apache на r1.
![linux_network](report-images/4-9.png)
Проверить соединение по TCP для **DNAT**, для этого с r1 подключиться к серверу Apache на ws22 командой `telnet` 
![linux_network](report-images/4-10.png)

## <div id = "Часть8"></div> Часть 8. Дополнительно. Знакомство с **SSH Tunnels**


Запустить веб-сервер **Apache** на ws22 только на localhost (то есть в файле */etc/apache2/ports.conf* изменить строку `Listen 80` на `Listen localhost:80`)
![linux_network](report-images/4-12.png)

Воспользоваться *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21
Воспользоваться *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11

![linux_network](report-images/4-13.png)
![linux_network](report-images/4-14.png)


![linux_network](report-images/4-15.png)
![linux_network](report-images/4-16.png)
